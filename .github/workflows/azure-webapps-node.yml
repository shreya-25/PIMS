name: Deploy PIMS backend + frontend

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Use Node.js 20
      uses: actions/setup-node@v3
      with:
        node-version: '20'

    # Install backend dependencies
    - name: Install backend deps
      working-directory: backend
      run: npm install

    # Install + build frontend
    - name: Install frontend deps
      working-directory: frontend
      run: npm install

    - name: Build frontend
      working-directory: frontend
      run: npm run build

    # Copy frontend build â†’ backend/build
    - name: Move frontend build into backend
      run: |
        rm -rf backend/build
        cp -r frontend/build backend/build

    # Upload only backend folder
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: pims-backend
        path: backend/

  deploy:
    runs-on: ubuntu-latest
    needs: build
    permissions:
      id-token: write
      contents: read

    steps:
    - name: Download built backend
      uses: actions/download-artifact@v4
      with:
        name: pims-backend

    - name: Azure Login
      uses: azure/login@v2
      with:
        client-id: ${{ secrets.AZUREAPPSERVICE_CLIENTID_3956D9505F21462996F36A6CCA629333 }}
        tenant-id: ${{ secrets.AZUREAPPSERVICE_TENANTID_8C7A7230F3D649D1B65780754391E937 }}
        subscription-id: ${{ secrets.AZUREAPPSERVICE_SUBSCRIPTIONID_097B630F1BCC4B3E9967BC778F170891 }}

    - name: Deploy to Azure
      uses: azure/webapps-deploy@v3
      with:
        app-name: 'pims'
        slot-name: 'Production'
        package: ./backend
